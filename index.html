<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WAR ROYALE: FAIR PLAY</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --p-color: #e67e22; --bg: #0f0f0f; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Arial Black', sans-serif; overflow: hidden; touch-action: manipulation; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; background: #1a1a1a; }
        .active { display: flex; }
        .auth-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        input { padding: 15px; border-radius: 12px; border: none; width: 280px; font-size: 16px; background: #222; color: white; border: 1px solid #444; }
        #top-info { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 10px 15px; z-index: 100; box-sizing: border-box; }
        #timer { position: absolute; left: 50%; transform: translateX(-50%); background: gold; color: black; padding: 5px 15px; border-radius: 0 0 15px 15px; font-weight: bold; border: 2px solid black; }
        #game-ui { position: absolute; bottom: 5px; width: 100%; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        #battle-deck { pointer-events: auto; display: flex; gap: 5px; padding: 10px; background: rgba(0,0,0,0.8); border-radius: 15px; overflow-x: auto; max-width: 95vw; }
        .unit-btn { min-width: 65px; height: 85px; background: #34495e; border: 2px solid gold; border-radius: 8px; color: white; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; }
        canvas { background: #27ae60; border: 4px solid #000; display: block; margin: 0 auto; width: 340px; height: 500px; }
        .hp-label { position: absolute; width: 100%; text-align: center; font-size: 18px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        button { padding: 15px; margin: 8px; border-radius: 12px; border: none; width: 280px; font-size: 16px; font-weight: bold; background: var(--p-color); color: white; cursor: pointer; }
        .list-container { background: rgba(0,0,0,0.9); border: 2px solid gold; border-radius: 15px; width: 90%; max-height: 50vh; overflow-y: auto; padding: 10px; }
        .item-box { background: #222; border-bottom: 1px solid #444; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .locked-card { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen active">
        <h1 style="color: gold;">WAR ROYALE</h1>
        <div class="auth-container">
            <input type="text" id="nickname" placeholder="–ù–Ü–ö–ù–ï–ô–ú">
            <input type="password" id="password" placeholder="–ü–ê–†–û–õ–¨">
            <button onclick="handleAuth()">–£–í–Ü–ô–¢–ò –í –ö–†–Ü–ü–û–°–¢–¨</button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div style="font-size: 32px; color: gold;">LVL: <span id="m-path">0</span></div>
        <button onclick="startBattle()" style="background: #c0392b;">–í –ë–Ü–ô ‚öîÔ∏è</button>
        <button onclick="openCards()">–ö–û–õ–û–î–ê üÉè</button>
        <button onclick="showLeaderboards('all')">–†–ï–ô–¢–ò–ù–ì ü•á</button>
        <button onclick="showScreen('promo-screen')">–ü–†–û–ú–û ‚öôÔ∏è</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="top-info">
            <div style="color: #ff4d4d;">–í–û–†–û–ì üíß: <span id="bot-elixir">5</span></div>
            <div id="timer">03:00</div>
            <div></div>
        </div>
        <div class="hp-label" style="top: 85px; color: #ff4d4d;" id="hp-enemy-text">5000</div>
        <canvas id="gameCanvas"></canvas>
        <div class="hp-label" style="bottom: 165px; color: #4d94ff;" id="hp-player-text">5000</div>
        <div id="game-ui">
            <div style="color:white; margin-bottom: 5px;">–¢–í–Ü–ô –ï–õ–Ü–ö–°–ò–†: üíß <span id="elixir-val">5</span></div>
            <div id="battle-deck"></div>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <h2 id="list-title" style="color: gold;">–†–ï–ô–¢–ò–ù–ì</h2>
        <div id="leader-tabs" style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button onclick="showLeaderboards('all')" style="width:130px; font-size:12px;">–£–°–Ü</button>
            <button onclick="showLeaderboards('cyborg')" style="width:130px; font-size:12px; background: #8e44ad;">–ö–Ü–ë–û–†–ì–ò</button>
        </div>
        <div id="generic-list" class="list-container"></div>
        <button onclick="showScreen('menu-screen')" style="margin-top:10px;">–ù–ê–ó–ê–î</button>
    </div>

    <div id="promo-screen" class="screen">
        <h2 style="color: gold;">–ü–†–û–ú–û–ö–û–î</h2>
        <input type="text" id="promo-input" placeholder="–í–í–ï–î–Ü–¢–¨ –ö–û–î">
        <button onclick="applyPromo()">–ê–ö–¢–ò–í–£–í–ê–¢–ò</button>
        <button onclick="showScreen('menu-screen')" style="background:#444">–ù–ê–ó–ê–î</button>
    </div>

<script>
const ALL_UNITS = [
    {id:0, n:'–õ—É—á–Ω–∏–∫', cost:2, hp:200, dmg:35, c1:'#f1c40f', sz:8, sp:1.1, mL:0},
    {id:1, n:'–ú–µ—á–Ω–∏–∫', cost:3, hp:650, dmg:50, c1:'#3498db', sz:10, sp:0.8, mL:0},
    {id:2, n:'–ú–∞–ª—é–∫ X2', cost:4, hp:550, dmg:70, c1:'#e67e22', sz:7, sp:1.3, mL:3},
    {id:3, n:'–õ—É—á–Ω–∏–∫+', cost:3, hp:350, dmg:55, c1:'#f1c40f', sz:8, sp:1.1, mL:5},
    {id:4, n:'–ë—Ä–æ–Ω.–ú–∞–ª', cost:4, hp:1100, dmg:45, c1:'#5d6d7e', sz:9, sp:0.7, mL:8},
    {id:5, n:'–ú–∞–ª—é–∫ X3', cost:4, hp:480, dmg:45, c1:'#e74c3c', sz:7, sp:1.3, mL:10},
    {id:6, n:'–ï.–õ—É—á–Ω–∏–∫', cost:3, hp:450, dmg:75, c1:'#f4d03f', sz:8, sp:1.1, mL:15},
    {id:7, n:'–ì–ª–æ–∫', cost:4, hp:650, dmg:85, c1:'#7f8c8d', sz:10, sp:0.9, mL:20},
    {id:8, n:'–°–Ω–∞–π–ø–µ—Ä', cost:5, hp:400, dmg:280, c1:'#1d8348', sz:9, sp:0.6, mL:25},
    {id:9, n:'–ê–ö-47', cost:5, hp:950, dmg:130, c1:'#27ae60', sz:10, sp:0.9, mL:33},
    {id:10, n:'–ê–ö-47 X2', cost:6, hp:1300, dmg:190, c1:'#1e8449', sz:11, sp:0.8, mL:33},
    {id:11, n:'–®—Ç—É—Ä–º', cost:5, hp:1200, dmg:95, c1:'#515a5a', sz:11, sp:0.7, mL:35},
    {id:12, n:'–ë–æ–º–±–∞', cost:5, hp:350, dmg:700, c1:'#34495e', sz:9, sp:1.4, mL:40},
    {id:13, n:'–í–æ–≥–Ω–µ–º–µ—Ç', cost:6, hp:1700, dmg:120, c1:'#e67e22', sz:11, sp:0.6, mL:45},
    {id:14, n:'–î—Ä–æ–±–∞—à', cost:5, hp:1600, dmg:220, c1:'#95a5a6', sz:11, sp:0.7, mL:50},
    {id:15, n:'–¢–ù–¢ X2', cost:6, hp:900, dmg:500, c1:'#c0392b', sz:10, sp:1.0, mL:50},
    {id:16, n:'–†–ü–ì', cost:7, hp:2100, dmg:350, c1:'#1b5e20', sz:12, sp:0.6, mL:60},
    {id:17, n:'–ú-–ö—ñ–±–æ—Ä–≥', cost:6, hp:2500, dmg:280, c1:'#8e44ad', sz:13, sp:0.6, mL:60},
    {id:18, n:'–¢–∞–Ω–∫', cost:8, hp:5500, dmg:350, c1:'#2ecc71', sz:20, sp:0.4, mL:70},
    {id:19, n:'–ö-–¢–∞–Ω–∫', cost:9, hp:6500, dmg:450, c1:'#8e44ad', sz:22, sp:0.4, mL:70},
    {id:20, n:'–ö-–í–µ–ª–µ—Ç', cost:10, hp:8000, dmg:550, c1:'#5b2c6f', sz:24, sp:0.3, mL:80},
    {id:21, n:'–ö–∞–∫—Ç—É—Å', cost:10, hp:9500, dmg:700, c1:'#2ecc71', sz:22, sp:0.3, mL:90},
    {id:22, n:'–î—Ä–∞–∫–æ–Ω—á–∏–∫', cost:5, hp:3500, dmg:250, c1:'#e67e22', sz:18, sp:0.7, mL:150},
    {id:23, n:'–ö-–î—Ä–∞–∫–æ–Ω', cost:7, hp:9000, dmg:450, c1:'#7f8c8d', sz:22, sp:0.6, mL:400},
    {id:24, n:'–ì-–î—Ä–∞–∫–æ–Ω', cost:9, hp:18000, dmg:900, c1:'#2c3e50', sz:26, sp:0.5, mL:800},
    {id:25, n:'–ï–ª-–î—Ä–∞–∫–æ–Ω', cost:10, hp:30000, dmg:1500, c1:'#f1c40f', sz:32, sp:0.4, mL:1300}
];

firebase.initializeApp({ databaseURL: "https://war-royl-default-rtdb.firebaseio.com" });
const db = firebase.database();
let player = { nick: '', pass: '', path: 0, deck: [0, 1], evo: [] };
let gameActive = false, elixir = 5, botElixir = 5, units = [], castles = {}, timeLeft = 180;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 340; canvas.height = 500;

window.onload = () => {
    const saved = localStorage.getItem('war_royale_fortress');
    if(saved) { const d = JSON.parse(saved); login(d.n, d.p); }
};

async function handleAuth() {
    const n = document.getElementById('nickname').value.trim();
    const p = document.getElementById('password').value.trim();
    if(n && p) login(n, p);
}

async function login(n, p) {
    const snap = await db.ref('users/' + n).once('value');
    if(snap.exists() && snap.val().pass !== p) return alert("–ü–ê–†–û–õ–¨ –ù–ï–í–Ü–†–ù–ò–ô");
    player = snap.exists() ? snap.val() : { nick: n, pass: p, path: 0, deck: [0, 1], evo: [] };
    if(!snap.exists()) db.ref('users/' + n).set(player);
    localStorage.setItem('war_royale_fortress', JSON.stringify({n, p}));
    updateUI(); showScreen('menu-screen');
}

function startBattle() {
    showScreen('game-screen');
    gameActive = true; units = []; elixir = 5; botElixir = 5; timeLeft = 180;
    castles = { 
        p: { hp: 5000 + (player.path * 100), x: 120, y: 450, w: 100, h: 40 }, 
        e: { hp: 5000 + (player.path * 50), x: 120, y: 10, w: 100, h: 40 } 
    };
    renderBattleDeck();
    
    // –ü–†–ê–í–ò–õ–¨–ù–ò–ô –¢–ê–ô–ú–ï–† –¢–ê –ï–õ–Ü–ö–°–ò–† (–ë–ï–ó –ë–ï–ó–ö–Ü–ù–ï–ß–ù–û–°–¢–Ü)
    const gameInt = setInterval(() => {
        if(!gameActive) { clearInterval(gameInt); return; }
        
        // –ü–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –µ–ª—ñ–∫—Å–∏—Ä—É (—Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ)
        elixir = Math.min(10, elixir + 0.5);
        botElixir = Math.min(10, botElixir + 0.5);
        
        timeLeft--;
        document.getElementById('timer').innerText = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
        
        // –õ–æ–≥—ñ–∫–∞ –±–æ—Ç–∞ (—Ç–µ–ø–µ—Ä —á–µ—Å–Ω–∞)
        const opt = ALL_UNITS.filter(u => u.mL <= player.path + 2 && u.cost <= botElixir);
        if(opt.length > 0 && Math.random() < 0.3) {
            let u = opt[Math.floor(Math.random()*opt.length)];
            // –°–£–í–û–†–ê –ü–ï–†–ï–í–Ü–†–ö–ê –ï–õ–Ü–ö–°–ò–†–£
            if(botElixir >= u.cost) {
                botElixir -= u.cost; 
                spawn(u, 'e');
            }
        }
    }, 1500); // –°–ø–æ–≤—ñ–ª—å–Ω–∏–ª–∏ —Ü–∏–∫–ª –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
    loop();
}

function spawn(u, team) {
    const m = player.evo?.includes(u.id) ? 3 : 1;
    units.push({ ...u, team, hp: u.hp*m, curHp: u.hp*m, dmg: u.dmg*m, x: 155+Math.random()*30, y: team==='p'?440:60 });
}

function loop() {
    if(!gameActive) return;
    ctx.fillStyle = "#27ae60"; ctx.fillRect(0,0,340,500);
    ctx.fillStyle = "#2980b9"; ctx.fillRect(0, 240, 340, 20); 
    ctx.fillStyle = "#7f8c8d"; ctx.fillRect(130, 230, 80, 40);

    ctx.fillStyle = "#c0392b"; ctx.fillRect(castles.e.x, castles.e.y, castles.e.w, castles.e.h); 
    ctx.fillStyle = "#2980b9"; ctx.fillRect(castles.p.x, castles.p.y, castles.p.w, castles.p.h); 

    units.forEach(u => {
        let enemy = units.find(e => e.team !== u.team && Math.hypot(e.x-u.x, e.y-u.y) < (u.sz + e.sz + 5));
        let threat = units.find(e => e.team !== u.team && Math.hypot(e.x-u.x, e.y-u.y) < 100);

        if(enemy) {
            enemy.curHp -= u.dmg/60;
        } else if (threat) {
            let dx = threat.x-u.x, dy = threat.y-u.y, dist = Math.sqrt(dx*dx+dy*dy);
            u.x += (dx/dist)*u.sp; u.y += (dy/dist)*u.sp;
        } else {
            let atEnemyGate = (u.team === 'p' && u.y <= castles.e.y + castles.e.h + 5);
            let atPlayerGate = (u.team === 'e' && u.y >= castles.p.y - 5);

            if(atEnemyGate) {
                castles.e.hp -= u.dmg/60;
            } else if(atPlayerGate) {
                castles.p.hp -= u.dmg/60;
            } else {
                if(u.x < 165) u.x += 0.3; else if(u.x > 175) u.x -= 0.3;
                u.y += u.team === 'p' ? -u.sp : u.sp;
            }
        }
        ctx.fillStyle = u.team === 'p' ? u.c1 : '#333';
        ctx.beginPath(); ctx.arc(u.x, u.y, u.sz, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.fillRect(u.x-10, u.y-u.sz-8, 20, 4);
        ctx.fillStyle = u.team === 'p' ? "lime" : "red";
        ctx.fillRect(u.x-10, u.y-u.sz-8, (u.curHp/u.hp)*20, 4);
    });

    units = units.filter(u => u.curHp > 0);
    document.getElementById('elixir-val').innerText = Math.floor(elixir);
    document.getElementById('hp-player-text').innerText = "–ö–†–Ü–ü–û–°–¢–¨: " + Math.floor(castles.p.hp);
    document.getElementById('hp-enemy-text').innerText = "–í–û–†–û–ì: " + Math.floor(castles.e.hp);
    document.getElementById('bot-elixir').innerText = Math.floor(botElixir);

    if(castles.p.hp <= 0 || castles.e.hp <= 0) endGame(castles.e.hp <= 0);
    else requestAnimationFrame(loop);
}

function endGame(win) {
    gameActive = false; alert(win ? "–ü–ï–†–ï–ú–û–ì–ê!" : "–ü–û–†–ê–ó–ö–ê!");
    if(win) player.path++;
    db.ref('users/' + player.nick).set(player);
    updateUI(); showScreen('menu-screen');
}

function applyPromo() {
    if(document.getElementById('promo-input').value === "BORIS") {
        if(!player.evo) player.evo = [];
        if(!player.evo.includes(17)) player.evo.push(17);
        db.ref('users/'+player.nick).update({evo: player.evo});
        alert("BORIS –ê–ö–¢–ò–í–û–í–ê–ù–û!");
    }
}

async function showLeaderboards(type) {
    showScreen('list-screen');
    document.getElementById('leader-tabs').style.display = 'flex';
    document.getElementById('list-title').innerText = type === 'cyborg' ? "–ö–Ü–ë–û–†–ì–ò" : "–†–ï–ô–¢–ò–ù–ì";
    const snap = await db.ref('users').once('value');
    let u = [];
    snap.forEach(s => {
        let d = s.val();
        if(type === 'all') u.push(d);
        else if(type === 'cyborg' && d.evo?.includes(17)) u.push(d);
    });
    u.sort((a,b) => b.path - a.path);
    document.getElementById('generic-list').innerHTML = u.slice(0,15).map((x,i) => `<div class="item-box">#${i+1} ${x.nick} <b>LVL: ${x.path}</b></div>`).join('');
}

function openCards() {
    showScreen('list-screen');
    document.getElementById('leader-tabs').style.display = 'none';
    document.getElementById('list-title').innerText = "–¢–í–û–Ø –ö–û–õ–û–î–ê";
    document.getElementById('generic-list').innerHTML = ALL_UNITS.map(u => {
        let lock = player.path < u.mL;
        return `<div class="item-box ${lock ? 'locked-card' : ''}" style="border:1px solid ${player.deck.includes(u.id)?'lime':'#444'}" onclick="toggleCard(${u.id}, ${lock})">
            <span>${lock ? 'üîí ' : ''}${u.n}</span> <span>üíß${u.cost}</span>
        </div>`;
    }).join('') + `<button onclick="saveDeck()" style="background:green">–ó–ë–ï–†–ï–ì–¢–ò</button>`;
}

function toggleCard(id, lock) {
    if(lock) return;
    if(player.deck.includes(id)) player.deck = player.deck.filter(i => i !== id);
    else if(player.deck.length < 5) player.deck.push(id);
    openCards();
}

function saveDeck() { db.ref('users/'+player.nick).update({deck:player.deck}); showScreen('menu-screen'); }
function updateUI() { document.getElementById('m-path').innerText = player.path; }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

function renderBattleDeck() {
    const d = document.getElementById('battle-deck'); d.innerHTML = '';
    player.deck.forEach(id => {
        const u = ALL_UNITS.find(x => x.id === id);
        const b = document.createElement('div'); b.className = 'unit-btn';
        b.innerHTML = `${u.n}<br>üíß${u.cost}`;
        b.onclick = () => { if(elixir >= u.cost) { elixir -= u.cost; spawn(u, 'p'); } };
        d.appendChild(b);
    });
}
</script>
</body>
</html>